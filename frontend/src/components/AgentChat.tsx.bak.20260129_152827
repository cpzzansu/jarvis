import { useMemo, useRef, useState } from "react";
import { useAgentStream } from "../hooks/useAgentStream";

type Mode = "disconnected" | "connected";

export default function AgentChat() {
  const [mode, setMode] = useState<Mode>("disconnected");
  const [prompt, setPrompt] = useState<string>("");
  const isComposingRef = useRef(false);
  const { status, output, error, start, stop, resetSession } = useAgentStream();

  const canConnect = useMemo(() => mode === "disconnected", [mode]);
  const canSend = useMemo(
    () => mode === "connected" && !!prompt.trim() && status !== "streaming",
    [mode, prompt, status]
  );

  const onConnect = () => {
    setMode("connected");
  };

  const onDisconnect = () => {
    stop();
    setMode("disconnected");
    setPrompt("");
  };

  const onSend = (valueFromInput?: string) => {
    const p = (valueFromInput !== undefined ? valueFromInput : prompt).trim();
    if (!p) return;
    start(p);
    setPrompt("");
  };

  return (
    <div style={{ maxWidth: 900, margin: "0 auto", padding: 16 }}>
      <h2>Jarvis Agent</h2>

      <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
        <input
          value={prompt}
          onChange={(e) => setPrompt(e.target.value)}
          onCompositionStart={() => {
            isComposingRef.current = true;
          }}
          onCompositionEnd={(e) => {
            isComposingRef.current = false;
            setPrompt((e.target as HTMLInputElement).value);
          }}
          placeholder={
            mode === "connected"
              ? "명령을 입력하세요"
              : "먼저 연결을 누른 뒤 명령을 입력하세요"
          }
          disabled={mode !== "connected"}
          onKeyDown={(e) => {
            if (e.key === "Enter") {
              if (isComposingRef.current) {
                e.preventDefault();
                return;
              }
              e.preventDefault();
              onSend((e.target as HTMLInputElement).value);
            }
          }}
          style={{ flex: 1, padding: 10 }}
        />

        <button
          onClick={onConnect}
          disabled={!canConnect}
          style={{ padding: "10px 14px" }}
        >
          연결
        </button>

        <button
          onClick={() => onSend()}
          disabled={!canSend}
          style={{ padding: "10px 14px" }}
        >
          보내기
        </button>

        <button
          onClick={stop}
          disabled={status !== "streaming"}
          style={{ padding: "10px 14px" }}
        >
          중지
        </button>

        <button
          onClick={onDisconnect}
          disabled={mode !== "connected"}
          style={{ padding: "10px 14px" }}
        >
          연결해제
        </button>

        <button
          onClick={() => resetSession()}
          disabled={mode !== "connected"}
          style={{ padding: "10px 14px" }}
          title="서버 세션을 끊고 다음 메시지부터 새 대화로 시작"
        >
          세션 초기화
        </button>
      </div>

      <div style={{ marginTop: 12, fontSize: 12, opacity: 0.8 }}>
        상태: {mode} / {status}
      </div>

      {error && (
        <div style={{ marginTop: 12, color: "crimson" }}>{error}</div>
      )}

      <pre
        style={{
          marginTop: 12,
          padding: 12,
          background: "#111",
          color: "#eee",
          minHeight: 240,
          whiteSpace: "pre-wrap",
          borderRadius: 8,
        }}
      >
        {output || "(응답 대기 중)"}
      </pre>
    </div>
  );
}
