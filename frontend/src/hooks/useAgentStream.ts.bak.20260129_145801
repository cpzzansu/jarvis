import { useCallback, useRef, useState } from "react";
import { subscribeAgentStream } from "../lib/api";

export type StreamStatus = "idle" | "streaming" | "error" | "done";

export function useAgentStream() {
  const [status, setStatus] = useState<StreamStatus>("idle");
  const [output, setOutput] = useState<string>("");
  const [error, setError] = useState<string | null>(null);

  const closeRef = useRef<null | (() => void)>(null);

  const stop = useCallback(() => {
    closeRef.current?.();
    closeRef.current = null;
    setStatus((s) => (s === "streaming" ? "done" : s));
  }, []);

  const start = useCallback((prompt: string) => {
    // reset
    stop();
    setOutput("");
    setError(null);
    setStatus("streaming");

    let receivedDone = false;

    const close = subscribeAgentStream(
      prompt,
      (evt) => {
        const raw = typeof evt.data === "string" ? evt.data : JSON.stringify(evt.data);
        let payload: { type?: string; text?: string; error?: string; ok?: boolean };
        try {
          payload = JSON.parse(raw);
        } catch {
          setOutput((prev) => prev + raw);
          return;
        }
        switch (payload.type) {
          case "chunk":
            if (payload.text != null) setOutput((prev) => prev + payload.text + "\n");
            break;
          case "done":
            receivedDone = true;
            setStatus("done");
            closeRef.current?.();
            closeRef.current = null;
            break;
          case "error":
            setError(payload.error ?? "알 수 없는 오류");
            setStatus("error");
            break;
          case "meta":
            // 연결 성공 메타; 무시
            break;
          default:
            setOutput((prev) => prev + raw + "\n");
        }
      },
      () => {
        // 서버가 연결을 닫으면 onerror가 호출됨. 이미 done 받았으면 무시
        if (!receivedDone) {
          setStatus("error");
          setError("SSE 연결 오류가 발생했습니다.");
        }
      }
    );

    closeRef.current = close;
  }, [stop]);

  return { status, output, error, start, stop };
}
